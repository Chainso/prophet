// Code generated by prophet-cli. DO NOT EDIT.

import type * as Actions from './actions.js';
import type * as EventContracts from './event-contracts.js';
import type { ActionContext, ActionHandlers } from './action-handlers.js';
import { createEventId } from '@prophet-ontology/events-runtime';
import {
  createCreateOrderResultEvent,
  createOrderApproveTransitionEvent,
  createOrderShipTransitionEvent,
  publishDomainEvents,
  toActionOutcome,
  type EventPublisher
} from './events.js';

export class ActionExecutionService {
  constructor(
    private readonly handlers: ActionHandlers,
    private readonly eventPublisher: EventPublisher,
  ) {}

  async approveOrder(input: Actions.ApproveOrderCommand, context: ActionContext): Promise<EventContracts.OrderApproveTransition> {
    const result = await this.handlers.approveOrder.handle(input, context);
    const outcome = toActionOutcome<EventContracts.OrderApproveTransition>(result);
    const events = [createOrderApproveTransitionEvent(outcome.output), ...outcome.additionalEvents];
    await publishDomainEvents(this.eventPublisher, events, {
      traceId: context.traceId ?? createEventId(),
      source: context.eventSource ?? 'commerce_local',
      attributes: context.eventAttributes,
    });
    return outcome.output;
  }

  async createOrder(input: Actions.CreateOrderCommand, context: ActionContext): Promise<EventContracts.CreateOrderResult> {
    const result = await this.handlers.createOrder.handle(input, context);
    const outcome = toActionOutcome<EventContracts.CreateOrderResult>(result);
    const events = [createCreateOrderResultEvent(outcome.output), ...outcome.additionalEvents];
    await publishDomainEvents(this.eventPublisher, events, {
      traceId: context.traceId ?? createEventId(),
      source: context.eventSource ?? 'commerce_local',
      attributes: context.eventAttributes,
    });
    return outcome.output;
  }

  async shipOrder(input: Actions.ShipOrderCommand, context: ActionContext): Promise<EventContracts.OrderShipTransition> {
    const result = await this.handlers.shipOrder.handle(input, context);
    const outcome = toActionOutcome<EventContracts.OrderShipTransition>(result);
    const events = [createOrderShipTransitionEvent(outcome.output), ...outcome.additionalEvents];
    await publishDomainEvents(this.eventPublisher, events, {
      traceId: context.traceId ?? createEventId(),
      source: context.eventSource ?? 'commerce_local',
      attributes: context.eventAttributes,
    });
    return outcome.output;
  }

}
