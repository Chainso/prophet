# Code generated by prophet-cli. DO NOT EDIT.
from __future__ import annotations

import dataclasses
import types

from typing import Any, Union, get_args, get_origin, get_type_hints

from flask import Blueprint, jsonify, request

from .action_handlers import ActionContext
from .action_service import ActionExecutionService
from .actions import *
from .persistence import Repositories
from .query import *

_TYPE_HINT_CACHE: dict[type, dict[str, Any]] = {}

def _coerce_value(expected_type: Any, value: Any) -> Any:
    if value is None:
        return None
    origin = get_origin(expected_type)
    if origin is list:
        (item_type,) = get_args(expected_type) or (Any,)
        if not isinstance(value, list):
            return value
        return [_coerce_value(item_type, item) for item in value]
    if origin is dict:
        return value
    if origin in (types.UnionType, Union):
        args = [item for item in get_args(expected_type) if item is not type(None)]
        if len(args) == 1:
            return _coerce_value(args[0], value)
        for arg in args:
            try:
                return _coerce_value(arg, value)
            except Exception:
                continue
        return value
    if isinstance(expected_type, type) and dataclasses.is_dataclass(expected_type):
        if isinstance(value, expected_type):
            return value
        if not isinstance(value, dict):
            return value
        hints = _TYPE_HINT_CACHE.get(expected_type)
        if hints is None:
            hints = get_type_hints(expected_type, globalns=globals(), localns=globals())
            _TYPE_HINT_CACHE[expected_type] = hints
        kwargs: dict[str, Any] = {}
        for field in dataclasses.fields(expected_type):
            if field.name in value:
                field_type = hints.get(field.name, Any)
                kwargs[field.name] = _coerce_value(field_type, value[field.name])
        return expected_type(**kwargs)
    return value

def build_generated_blueprint(service: ActionExecutionService, context: ActionContext, repositories: Repositories) -> Blueprint:
    bp = Blueprint('prophet_generated', __name__)

    @bp.post('/actions/approveOrder')
    def action_approveOrder():
        payload = request.get_json(silent=True) or {}
        input_model = _coerce_value(ApproveOrderCommand, payload)
        result = service.execute_approveOrder(input_model, context)
        return jsonify(dataclasses.asdict(result))

    @bp.post('/actions/createOrder')
    def action_createOrder():
        payload = request.get_json(silent=True) or {}
        input_model = _coerce_value(CreateOrderCommand, payload)
        result = service.execute_createOrder(input_model, context)
        return jsonify(dataclasses.asdict(result))

    @bp.post('/actions/shipOrder')
    def action_shipOrder():
        payload = request.get_json(silent=True) or {}
        input_model = _coerce_value(ShipOrderCommand, payload)
        result = service.execute_shipOrder(input_model, context)
        return jsonify(dataclasses.asdict(result))

    @bp.get('/orders')
    def list_order():
        page = int(request.args.get('page', 0))
        size = int(request.args.get('size', 20))
        result = repositories.order.list(page, size)
        return jsonify(dataclasses.asdict(result))

    @bp.get('/orders/<id>')
    def get_order(id):
        item = repositories.order.get_by_id(OrderRef(orderId=id))
        if item is None:
            return jsonify({'error': 'not_found'}), 404
        return jsonify(dataclasses.asdict(item))

    @bp.post('/orders/query')
    def query_order():
        page = int(request.args.get('page', 0))
        size = int(request.args.get('size', 20))
        payload = request.get_json(silent=True) or {}
        filter_model = _coerce_value(OrderQueryFilter, payload)
        result = repositories.order.query(filter_model, page, size)
        return jsonify(dataclasses.asdict(result))

    @bp.get('/users')
    def list_user():
        page = int(request.args.get('page', 0))
        size = int(request.args.get('size', 20))
        result = repositories.user.list(page, size)
        return jsonify(dataclasses.asdict(result))

    @bp.get('/users/<id>')
    def get_user(id):
        item = repositories.user.get_by_id(UserRef(userId=id))
        if item is None:
            return jsonify({'error': 'not_found'}), 404
        return jsonify(dataclasses.asdict(item))

    @bp.post('/users/query')
    def query_user():
        page = int(request.args.get('page', 0))
        size = int(request.args.get('size', 20))
        payload = request.get_json(silent=True) or {}
        filter_model = _coerce_value(UserQueryFilter, payload)
        result = repositories.user.query(filter_model, page, size)
        return jsonify(dataclasses.asdict(result))

    return bp
