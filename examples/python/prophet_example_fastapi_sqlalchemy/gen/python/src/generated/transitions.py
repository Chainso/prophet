# Code generated by prophet-cli. DO NOT EDIT.
from __future__ import annotations

from dataclasses import dataclass
from dataclasses import field
from typing import Dict, Optional, Protocol, Union

from prophet_events_runtime import TransitionValidationResult

from .domain import *
from .event_contracts import *
from .persistence import Repositories

@dataclass
class OrderApproveTransitionDraft:
    _seed: Dict[str, object]
    _fields: Dict[str, object] = field(default_factory=dict)

    def with_fields(self, **fields: object) -> 'OrderApproveTransitionDraft':
        self._fields.update(fields)
        return self

    def build(self, **fields: object) -> OrderApproveTransition:
        payload = dict(self._seed)
        payload.update(self._fields)
        payload.update(fields)
        return OrderApproveTransition(**payload)

@dataclass
class OrderShipTransitionDraft:
    _seed: Dict[str, object]
    _fields: Dict[str, object] = field(default_factory=dict)

    def with_fields(self, **fields: object) -> 'OrderShipTransitionDraft':
        self._fields.update(fields)
        return self

    def build(self, **fields: object) -> OrderShipTransition:
        payload = dict(self._seed)
        payload.update(self._fields)
        payload.update(fields)
        return OrderShipTransition(**payload)

OrderRefOrObject = Union[OrderRef, Order]

class OrderTransitionHandler(Protocol):
    async def approveOrder(self, target: OrderRefOrObject) -> OrderApproveTransitionDraft: ...
    async def shipOrder(self, target: OrderRefOrObject) -> OrderShipTransitionDraft: ...

class OrderTransitionValidator(Protocol):
    async def validateApproveOrder(self, target: Order) -> TransitionValidationResult: ...
    async def validateShipOrder(self, target: Order) -> TransitionValidationResult: ...

class OrderTransitionValidatorDefault:
    async def validateApproveOrder(self, _target: Order) -> TransitionValidationResult:
        return TransitionValidationResult(passesValidation=True)

    async def validateShipOrder(self, _target: Order) -> TransitionValidationResult:
        return TransitionValidationResult(passesValidation=True)

class OrderTransitionHandlerDefault:
    def __init__(self, repository: OrderRepository, validator: Optional[OrderTransitionValidator] = None):
        self._repository = repository
        self._validator = validator if validator is not None else OrderTransitionValidatorDefault()

    async def approveOrder(self, target: OrderRefOrObject) -> OrderApproveTransitionDraft:
        id = OrderRef(
            orderId=target.orderId,
        )
        current = await self._repository.get_by_id(id)
        if current is None:
            raise RuntimeError("Order not found for transition 'approve'")
        validation = await self._validator.validateApproveOrder(current)
        if not validation.passesValidation:
            raise RuntimeError(validation.failureReason or "Transition validation failed for Order.approve")
        transitioned = await self._repository.apply_transition(id, 'created', 'approved', 'trans_order_approve')
        if transitioned is None:
            latest = await self._repository.get_by_id(id)
            if latest is None:
                raise RuntimeError("Order not found for transition 'approve'")
            raise RuntimeError(f"Invalid state transition Order.approve: expected created but was {latest.state}")
        seed: Dict[str, object] = {}
        seed['orderId'] = transitioned.orderId
        seed['fromState'] = 'created'
        seed['toState'] = 'approved'
        return OrderApproveTransitionDraft(_seed=seed)

    async def shipOrder(self, target: OrderRefOrObject) -> OrderShipTransitionDraft:
        id = OrderRef(
            orderId=target.orderId,
        )
        current = await self._repository.get_by_id(id)
        if current is None:
            raise RuntimeError("Order not found for transition 'ship'")
        validation = await self._validator.validateShipOrder(current)
        if not validation.passesValidation:
            raise RuntimeError(validation.failureReason or "Transition validation failed for Order.ship")
        transitioned = await self._repository.apply_transition(id, 'approved', 'shipped', 'trans_order_ship')
        if transitioned is None:
            latest = await self._repository.get_by_id(id)
            if latest is None:
                raise RuntimeError("Order not found for transition 'ship'")
            raise RuntimeError(f"Invalid state transition Order.ship: expected approved but was {latest.state}")
        seed: Dict[str, object] = {}
        seed['orderId'] = transitioned.orderId
        seed['fromState'] = 'approved'
        seed['toState'] = 'shipped'
        return OrderShipTransitionDraft(_seed=seed)

class OrderTransitionService(OrderTransitionHandler, Protocol):
    pass

class OrderTransitionServiceDefault:
    def __init__(self, repositories: Repositories, handler: Optional[OrderTransitionHandler] = None, validator: Optional[OrderTransitionValidator] = None):
        self._delegate = handler if handler is not None else OrderTransitionHandlerDefault(repositories.order, validator)

    async def approveOrder(self, target: OrderRefOrObject) -> OrderApproveTransitionDraft:
        return await self._delegate.approveOrder(target)

    async def shipOrder(self, target: OrderRefOrObject) -> OrderShipTransitionDraft:
        return await self._delegate.shipOrder(target)

class TransitionHandlers(Protocol):
    order: Optional[OrderTransitionHandler]

class TransitionValidators(Protocol):
    order: Optional[OrderTransitionValidator]

class TransitionServices:
    def __init__(self, repositories: Repositories, handlers: Optional[TransitionHandlers] = None, validators: Optional[TransitionValidators] = None):
        self.order = OrderTransitionServiceDefault(repositories, getattr(handlers, 'order', None) if handlers is not None else None, getattr(validators, 'order', None) if validators is not None else None)
