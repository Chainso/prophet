name: Publish prophet-lib runtimes

on:
  push:
    tags:
      - "lib-v*.*.*"
  workflow_dispatch:
    inputs:
      release_version:
        description: "Version to release (must match prophet-lib/VERSION and all runtime manifests)"
        required: true
        type: string
      stage:
        description: "Release stage"
        required: true
        type: choice
        default: test
        options:
          - test
          - public
      publish_javascript:
        description: "Publish JavaScript runtime"
        required: true
        type: boolean
        default: true
      publish_python:
        description: "Publish Python runtime"
        required: true
        type: boolean
        default: true
      publish_java:
        description: "Publish Java runtime"
        required: true
        type: boolean
        default: true

concurrency:
  group: publish-prophet-lib-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  resolve-publish-config:
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.resolve.outputs.release_version }}
      stage: ${{ steps.resolve.outputs.stage }}
      publish_javascript: ${{ steps.resolve.outputs.publish_javascript }}
      publish_python: ${{ steps.resolve.outputs.publish_python }}
      publish_java: ${{ steps.resolve.outputs.publish_java }}

    steps:
      - name: Resolve publish configuration
        id: resolve
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
          INPUT_RELEASE_VERSION: ${{ inputs.release_version }}
          INPUT_STAGE: ${{ inputs.stage }}
          INPUT_PUBLISH_JAVASCRIPT: ${{ inputs.publish_javascript }}
          INPUT_PUBLISH_PYTHON: ${{ inputs.publish_python }}
          INPUT_PUBLISH_JAVA: ${{ inputs.publish_java }}
        run: |
          set -euo pipefail

          normalize_bool() {
            case "${1,,}" in
              true|1|yes) echo "true" ;;
              false|0|no) echo "false" ;;
              *)
                echo "invalid boolean value: $1" >&2
                exit 1
                ;;
            esac
          }

          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            release_version="${INPUT_RELEASE_VERSION}"
            stage="${INPUT_STAGE}"
            publish_javascript="$(normalize_bool "${INPUT_PUBLISH_JAVASCRIPT}")"
            publish_python="$(normalize_bool "${INPUT_PUBLISH_PYTHON}")"
            publish_java="$(normalize_bool "${INPUT_PUBLISH_JAVA}")"
          else
            if [[ ! "${REF_NAME}" =~ ^lib-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              echo "unsupported tag '${REF_NAME}' for prophet-lib publish workflow" >&2
              exit 1
            fi
            release_version="${BASH_REMATCH[1]}"
            stage="public"
            publish_javascript="true"
            publish_python="true"
            publish_java="true"
          fi

          if [[ -z "${release_version}" ]]; then
            echo "release_version resolved to an empty value" >&2
            exit 1
          fi

          case "${stage}" in
            test|public) ;;
            *)
              echo "invalid stage '${stage}', expected test or public" >&2
              exit 1
              ;;
          esac

          {
            echo "release_version=${release_version}"
            echo "stage=${stage}"
            echo "publish_javascript=${publish_javascript}"
            echo "publish_python=${publish_python}"
            echo "publish_java=${publish_java}"
          } >> "$GITHUB_OUTPUT"

  validate-versions:
    runs-on: ubuntu-latest
    needs: resolve-publish-config

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate release version alignment
        env:
          RELEASE_VERSION: ${{ needs.resolve-publish-config.outputs.release_version }}
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import re
          import tomllib

          expected = pathlib.Path("prophet-lib/VERSION").read_text(encoding="utf-8").strip()
          requested = os.environ["RELEASE_VERSION"].strip()

          if requested != expected:
              raise SystemExit(
                  f"resolved release_version={requested!r} does not match prophet-lib/VERSION={expected!r}"
              )

          package_json = json.loads(pathlib.Path("prophet-lib/javascript/package.json").read_text(encoding="utf-8"))
          js_version = package_json["version"].strip()

          pyproject = tomllib.loads(pathlib.Path("prophet-lib/python/pyproject.toml").read_text(encoding="utf-8"))
          py_version = pyproject["project"]["version"].strip()

          java_build = pathlib.Path("prophet-lib/java/build.gradle.kts").read_text(encoding="utf-8")
          match = re.search(r'^\s*version\s*=\s*"([^"]+)"', java_build, re.MULTILINE)
          if not match:
              raise SystemExit("could not find Java runtime version in prophet-lib/java/build.gradle.kts")
          java_version = match.group(1).strip()

          versions = {
              "prophet-lib/VERSION": expected,
              "prophet-lib/javascript/package.json": js_version,
              "prophet-lib/python/pyproject.toml": py_version,
              "prophet-lib/java/build.gradle.kts": java_version,
          }
          mismatches = {name: value for name, value in versions.items() if value != expected}
          if mismatches:
              joined = ", ".join(f"{name}={value!r}" for name, value in mismatches.items())
              raise SystemExit(f"runtime version mismatch against prophet-lib/VERSION={expected!r}: {joined}")
          print(f"release version {expected} validated across prophet-lib runtimes")
          PY

  javascript-runtime:
    runs-on: ubuntu-latest
    needs: [resolve-publish-config, validate-versions]
    if: ${{ needs.resolve-publish-config.outputs.publish_javascript == 'true' }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Validate JavaScript runtime
        working-directory: prophet-lib/javascript
        run: |
          npm test
          npm pack --dry-run

      - name: Publish JavaScript runtime to npm
        if: ${{ needs.resolve-publish-config.outputs.stage == 'public' }}
        working-directory: prophet-lib/javascript
        run: npm publish --access public --provenance

  python-runtime:
    runs-on: ubuntu-latest
    needs: [resolve-publish-config, validate-versions]
    if: ${{ needs.resolve-publish-config.outputs.publish_python == 'true' }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate Python runtime
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine
          PYTHONPATH=prophet-lib/python/src python -m unittest discover -s prophet-lib/python/tests -p 'test_*.py' -v
          python -m build prophet-lib/python
          python -m twine check prophet-lib/python/dist/*

      - name: Publish Python runtime to TestPyPI
        if: ${{ needs.resolve-publish-config.outputs.stage == 'test' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: prophet-lib/python/dist
          repository-url: https://test.pypi.org/legacy/

      - name: Publish Python runtime to PyPI
        if: ${{ needs.resolve-publish-config.outputs.stage == 'public' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: prophet-lib/python/dist

  java-runtime:
    runs-on: ubuntu-latest
    needs: [resolve-publish-config, validate-versions]
    if: ${{ needs.resolve-publish-config.outputs.publish_java == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Validate Java runtime
        working-directory: examples/java/prophet_example_spring
        run: ./gradlew -p ../../../prophet-lib/java test

      - name: Publish Java runtime to Maven Local (test stage)
        if: ${{ needs.resolve-publish-config.outputs.stage == 'test' }}
        working-directory: examples/java/prophet_example_spring
        run: ./gradlew -p ../../../prophet-lib/java publishToMavenLocal

      - name: Publish Java runtime to Maven Central
        if: ${{ needs.resolve-publish-config.outputs.stage == 'public' }}
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          MAVEN_GPG_PRIVATE_KEY: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
        run: |
          if [ -z "${SONATYPE_USERNAME:-}" ] || [ -z "${SONATYPE_PASSWORD:-}" ]; then
            echo "SONATYPE_USERNAME and SONATYPE_PASSWORD are required for public publish." >&2
            exit 1
          fi
          if [ -z "${MAVEN_GPG_PRIVATE_KEY:-}" ]; then
            echo "MAVEN_GPG_PRIVATE_KEY is required for public publish." >&2
            exit 1
          fi
          cd examples/java/prophet_example_spring
          ./gradlew -p ../../../prophet-lib/java publish
