name: Publish prophet-lib runtimes

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Version to release (must match prophet-lib/VERSION and all runtime manifests)"
        required: true
        type: string
      stage:
        description: "Release stage"
        required: true
        type: choice
        default: test
        options:
          - test
          - public
      publish_javascript:
        description: "Publish JavaScript runtime"
        required: true
        type: boolean
        default: true
      publish_python:
        description: "Publish Python runtime"
        required: true
        type: boolean
        default: true
      publish_java:
        description: "Publish Java runtime"
        required: true
        type: boolean
        default: true

concurrency:
  group: publish-prophet-lib-${{ github.ref }}-${{ inputs.release_version }}-${{ inputs.stage }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  validate-versions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate release version alignment
        env:
          RELEASE_VERSION: ${{ inputs.release_version }}
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import re
          import tomllib

          expected = pathlib.Path("prophet-lib/VERSION").read_text(encoding="utf-8").strip()
          requested = os.environ["RELEASE_VERSION"].strip()

          if requested != expected:
              raise SystemExit(
                  f"workflow input release_version={requested!r} does not match prophet-lib/VERSION={expected!r}"
              )

          package_json = json.loads(pathlib.Path("prophet-lib/javascript/package.json").read_text(encoding="utf-8"))
          js_version = package_json["version"].strip()

          pyproject = tomllib.loads(pathlib.Path("prophet-lib/python/pyproject.toml").read_text(encoding="utf-8"))
          py_version = pyproject["project"]["version"].strip()

          java_build = pathlib.Path("prophet-lib/java/build.gradle.kts").read_text(encoding="utf-8")
          match = re.search(r'^version\\s*=\\s*"([^"]+)"', java_build, re.MULTILINE)
          if not match:
              raise SystemExit("could not find Java runtime version in prophet-lib/java/build.gradle.kts")
          java_version = match.group(1).strip()

          versions = {
              "prophet-lib/VERSION": expected,
              "prophet-lib/javascript/package.json": js_version,
              "prophet-lib/python/pyproject.toml": py_version,
              "prophet-lib/java/build.gradle.kts": java_version,
          }
          mismatches = {name: value for name, value in versions.items() if value != expected}
          if mismatches:
              joined = ", ".join(f"{name}={value!r}" for name, value in mismatches.items())
              raise SystemExit(f"runtime version mismatch against prophet-lib/VERSION={expected!r}: {joined}")
          print(f"release version {expected} validated across prophet-lib runtimes")
          PY

  javascript-runtime:
    runs-on: ubuntu-latest
    needs: validate-versions
    if: ${{ inputs.publish_javascript }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Validate JavaScript runtime
        working-directory: prophet-lib/javascript
        run: |
          npm test
          npm pack --dry-run

      - name: Publish JavaScript runtime to npm
        if: ${{ inputs.stage == 'public' }}
        working-directory: prophet-lib/javascript
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN secret is required for public publish." >&2
            exit 1
          fi
          npm publish --access public --provenance

  python-runtime:
    runs-on: ubuntu-latest
    needs: validate-versions
    if: ${{ inputs.publish_python }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate Python runtime
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine
          PYTHONPATH=prophet-lib/python/src python -m unittest discover -s prophet-lib/python/tests -p 'test_*.py' -v
          python -m build prophet-lib/python
          python -m twine check prophet-lib/python/dist/*

      - name: Publish Python runtime to TestPyPI
        if: ${{ inputs.stage == 'test' }}
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          if [ -z "${TWINE_PASSWORD:-}" ]; then
            echo "TEST_PYPI_API_TOKEN secret is required for test-stage publish." >&2
            exit 1
          fi
          python -m twine upload --repository-url https://test.pypi.org/legacy/ prophet-lib/python/dist/*

      - name: Publish Python runtime to PyPI
        if: ${{ inputs.stage == 'public' }}
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "${TWINE_PASSWORD:-}" ]; then
            echo "PYPI_API_TOKEN secret is required for public publish." >&2
            exit 1
          fi
          python -m twine upload prophet-lib/python/dist/*

  java-runtime:
    runs-on: ubuntu-latest
    needs: validate-versions
    if: ${{ inputs.publish_java }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Validate Java runtime
        working-directory: examples/java/prophet_example_spring
        run: ./gradlew -p ../../../prophet-lib/java test

      - name: Publish Java runtime to Maven Local (test stage)
        if: ${{ inputs.stage == 'test' }}
        working-directory: examples/java/prophet_example_spring
        run: ./gradlew -p ../../../prophet-lib/java publishToMavenLocal

      - name: Publish Java runtime to Maven Central
        if: ${{ inputs.stage == 'public' }}
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          MAVEN_GPG_PRIVATE_KEY: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
        run: |
          if [ -z "${SONATYPE_USERNAME:-}" ] || [ -z "${SONATYPE_PASSWORD:-}" ]; then
            echo "SONATYPE_USERNAME and SONATYPE_PASSWORD are required for public publish." >&2
            exit 1
          fi
          if [ -z "${MAVEN_GPG_PRIVATE_KEY:-}" ]; then
            echo "MAVEN_GPG_PRIVATE_KEY is required for public publish." >&2
            exit 1
          fi
          cd examples/java/prophet_example_spring
          ./gradlew -p ../../../prophet-lib/java publish
